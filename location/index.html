<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="md5.min.js"></script>
  <script src="sha1.min.js"></script>
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <!-- <script src="./axios.js"></script> -->
  <script src="./jquery.js"></script>
  <title>好友定位</title>
  <script>
    // var _hmt = _hmt || [];
    // (function () {
    //   var hm = document.createElement("script");
    //   hm.src = "https://hm.baidu.com/hm.js?1831cf5cdd77593e3b63f8c7cd81e33e";
    //   var s = document.getElementsByTagName("script")[0];
    //   s.parentNode.insertBefore(hm, s);
    // })();
  </script>
</head>
<style>
  .total {
    position: fixed;
    width: 100%;
    height: 100%;
    left: 0;
    top: 0;
    background: url('./img/map@2x.png') no-repeat 0 0;
    background-size: cover;
  }


  .total>.phone {
    display: inline-block;
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    margin: auto;
  }

  .phone>.ad {
    width: 75%;
    overflow: hidden;
    z-index: 100;
    background: url('./img/bg@2x.png') no-repeat -100px -100px;
    background-size: 300%;
    /* background: rgba(255, 255, 255, 0.6); */
    box-shadow: 0px 2px 24px 0px rgba(0, 0, 0, 0.1);
    border-radius: 16px;
    position: absolute;
    left: 0;
    right: 0;
    top: 12%;
    margin: auto;
    padding: 24px 0 25px;
    box-sizing: border-box;
  }

  .phone>.ad>div:first-child img {
    width: 60px;
    height: 60px;
    margin-bottom: 15px;
    border-radius: 13px;
    overflow: hidden
  }

  .phone>.ad>div:nth-child(2) {
    font-size: 18px;
    font-family: PingFangSC-Semibold, PingFang SC;
    font-weight: 600;
    color: #000000;
    line-height: 25px;
    text-shadow: 0px 2px 24px rgba(0, 0, 0, 0.1);
    text-align: center;
  }

  .phone>.ad>div:nth-child(3) {
    margin: 3px 0 11px;
    text-align: center;
    font-size: 12px;
    font-family: PingFangSC-Regular, PingFang SC;
    font-weight: 400;
    color: rgba(0, 0, 0, 0.7);
    line-height: 17px;
    text-shadow: 0px 2px 24px rgba(0, 0, 0, 0.1);

  }

  /* .phone>.ad>.bg {
    background: rgba(0, 0, 0, 0.3);
    width: 100%;
    height: 100%;
    position: absolute;
    border-radius: 16px;
    left: 0;
    top: 0;
    z-index: -10;
  } */

  .phone>.ad>div:nth-child(4) img {
    width: 119px;
    height: 40px;
  }

  a {
    text-decoration: none;
  }
</style>

<body>
  <a href="https://apps.apple.com/cn/app/id1544397401" download>
    <div class="total">
      <div class="phone" id="phone">
        <img style="width: 100%;height: 100%;" src="./img/phone.png" alt="">
        <div class="ad">
          <div style="text-align:center;;"><img src="./img/icon.png" alt=""></div>
          <div>Friends Positioning</div>
          <div>Locate friends , no need to install</div>
          <div style="text-align:center"><img src="./img/appstore@2x.png" alt=""></div>
          <!-- <div class="bg"></div> -->
        </div>
      </div>
    </div>
  </a>
  <script>
    var time = 0;
    let phone = document.getElementById('phone');
    phone.style.height = 0.90 * window.innerHeight + 'px';
    phone.style.width = 0.445 * window.innerHeight + 'px';
    let url = window.location.href;
    var local = url.split('location=')[1];
    function require(params, url) {
      time++;
      let jsonStr = JSON.stringify(params);
      let ts = new Date().getTime();
      // 随机字符串
      let num = Math.ceil(Math.random() * 8 + 10);
      // 获取随机字符串
      function getstr(a) {
        var d,
          e,
          b = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
          c = "";
        for (d = 0; a > d; d += 1)
          (e = Math.random() * b.length), (e = Math.floor(e)), (c += b.charAt(e));
        return c;
      }
      let nonce = getstr(num);
      let str = sha1(md5(jsonStr) + ts + nonce + "sjsidhfiuhifgbhgergis");
      var headers = {
        "X-TimeStamp": ts,
        "X-Nonce": nonce,
        "X-Signature": str,
        "X-APPID": 12,
        "X-AuthVer": '1.0',
        "Access-Control-Allow-Origin": "https://cdn.52yqs.com",
        "Access-Control-Allow-Methods": "POST",
        "Access-Control-Allow-Credentials": "true"
        // "Access-Control-Allow-Origin": "*",
        // "Access-Control-Allow-Methods": "*",
        // "Access-Control-Allow-Headers":"content-type,token,id",
        // "Access-Control-Request-Headers":"Origin, X-Requested-With, content-Type, Accept, Authorization"
      };
      return new Promise((resolve, reject) => {
        $.ajax({
          method: 'post',
          url: 'https://xj.52yqs.com/ftapp/v1/locations/report/',
          contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
          data: JSON.stringify(params),
          dataType: 'json',
          headers: headers,
          success: (res => {
            resolve(res);
            console.log(res)
          }),
          error: (res => {
            reject(error)
            console.log(res)

          })
        })
        // this.axios
        //   .post(`${url}`, params, {
        //     headers: headers
        //   })
        //   .then((res) => {
        //     console.log(res)
        //     resolve(res);
        //   })
      })
    }
    var longitude = ''
    var latitude = ''
    window.onload = () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(this.showPosition, this.showError);
      } else {
        alert("浏览器不支持地理定位");
      }
      //调用coords的latitude和longitude即可获取到用户的纬度和经度。
    };
    showPosition = (position) => {
      longitude = position.coords.longitude; //经度
      latitude = position.coords.latitude; //纬度
      // this._position.lon = lag;
      // this._position.lat = lat;
      console.log(position);
      // alert('经度:' + longitude + ',纬度:' + latitude);
      let params = {
        location: local + '',
        longitude: longitude + '',
        latitude: latitude + ''
      }
      this.sendPosition(params)
    };
    var sendPosition = (params) => {
      this.require(params, 'https://xj.52yqs.com/ftapp/v1/locations/report/').then(res => {
        if (res.status !== 'ok') {
          setTimeout(() => {
            if (time <= 5) {
              this.sendPosition(params)
            } else {
              alert("定位失败,请检测网络设置！");
            }
          },1500)
        }
      }).catch(res => {
        console.log(res)
      })
    }
    // 上面的代码可以知道，如果用户设备支持地理定位，则运行 getCurrentPosition() 方法。如果getCurrentPosition()运行成功，则向参数showPosition中规定的函数返回一个coordinates对象，getCurrentPosition() 方法的第二个参数showError用于处理错误，它规定当获取用户位置失败时运行的函数。
    // 我们先来看函数showError()，它规定获取用户地理位置失败时的一些错误代码处理方式：
    showError = (error) => {
      // console.log()
      switch (error.code) {
        case error.PERMISSION_DENIED:
          alert("定位失败,用户拒绝请求地理定位");
          break;
        case error.POSITION_UNAVAILABLE:
          alert("定位失败,位置信息是不可用");
          break;
        case error.TIMEOUT:
          alert("定位失败,请求获取用户位置超时");
          break;
        case error.UNKNOWN_ERROR:
          alert("定位失败,定位系统失效");
          break;
      }
    }
  </script>
</body>

</html>